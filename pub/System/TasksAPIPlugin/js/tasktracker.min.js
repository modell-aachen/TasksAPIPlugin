!function(a,b,c,d,e){"use strict";var f={},g={};a.fn.tasksGrid=function(){return typeof b==typeof e?(p("Missing dependency underscore.js"),this):this.each(function(){var c=a(this),d=c.attr("id"),e=c.children(".settings").text(),j=a.parseJSON(e),n=decodeURIComponent(j.template);j.template=b.template(n),j.canLoadMore=!0,j.page=0,j.cntHeight=c.height(),j.container=c.find(".tasks > div"),f[d]=j,h(d,!0);var q=c.children(".tasks"),r=c.children(".editor"),s=c.children(".filter"),t=r.find(".btn-save"),u=r.find(".btn-cancel"),v=s.find(".btn-create"),w=function(){var b=a(this),c=f[d],e=b.scrollTop(),g=parseInt(e/c.cntHeight);c.canLoadMore&&g>c.page&&(c.page=g,a.blockUI(),h(d).done(function(a){c.canLoadMore=a.length>0}).always(a.unblockUI))},x=function(){return q.removeClass("edit"),r.removeClass("active"),q.find(".task").removeClass("faded selected"),r.find("input,select,textarea").each(function(){var b=a(this);b.val(""),b.trigger("Clear")}),!1},y=function(){var c=l(r);if(null===c)return!1;if(r.data("new")===!0){{moment()}return c.form=j.form,a.blockUI(),a.taskapi.create(c).fail(p).always(a.unblockUI).done(function(b){var e=a(j.template(c));e.find(".btn-edit").on("click",f[d].onEditClicked),e.data("id",b.id),j.container.prepend(e),r.data("new",""),u.click()}),!1}var e=q.find(".selected"),h=e.data("id");c.id=h;var k=b.findWhere(g[d],{id:h}),m=i(k);return a.blockUI(),a.taskapi.update(c).fail(p).always(a.unblockUI).done(function(){var b=a(j.template(c));e.html(b.html()),e.find(".btn-edit").on("click",f[d].onEditClicked),o(k,c,m),u.click()}),!1},z=function(){a(this).closest(".tasktracker").attr("id");return r.addClass("active"),q.addClass("edit"),k(r),r.data("new",!0),m(j.container.children(),null),!1};return q.on("scroll",w),u.on("click",x),t.on("click",y),v.on("click",z),this})};var h=function(c,d){var e=a.Deferred(),h=f[c];g[c]&&"number"==typeof g[c].length||(g[c]=[]);var k=h.container.parent(),l=k.parent(),o=l.children(".editor");h.onEditClicked=function(){var c=a(this).closest(".tasktracker").attr("id"),d=a(this).closest(".task");o.addClass("active"),k.addClass("edit");var e=b.findWhere(g[c],{id:d.data("id")}),f=i(e);j(o,f,e),m(h.container.children(),d)};var p=h.pageSize*(d===!0?2:1),q=["field_Context_s:",h.context," ",h.query].join("");return a.taskapi.get(q,p,h.page).done(function(b){for(var d=b.response.docs,f=0;f<d.length;++f){var i=d[f];g[c].push(i);var j=n(i),k=h.template(j),l=a(k);l.data("id",i.id),h.container.append(l),l.find(".btn-edit").on("click",h.onEditClicked)}e.resolve(d)}).fail(e.reject),e.promise()},i=function(a){var c=Object.getOwnPropertyNames(a),d=b.filter(c,function(a){return/^field_/.test(a)}),e=[];return b.each(d,function(a){var b=a.match(/^field_(.+)_(.+)/);if(b&&b.length>2){var c={name:b[1],type:b[2],raw:a};e.push(c)}}),e},j=function(c,d,e){var f=a(c);b.each(d,function(a){var b=["input#",a.name,",",'input[name="',a.name,'"],textarea[name="',a.name,'"],select[name="',a.name,'"]'].join(""),c=f.find(b);if(c.length>0){var d=e[a.raw];if("lst"===a.type)/^https?:\/\//.test(d)||c.trigger("AddValue",d);else if("dt"===a.type){var g=moment(d);c.val(g.format("DD MMM YYYY"))}else c.val(e[a.raw])}})},k=function(){a("input,textarea").each(function(){var b=a(this);b.val(""),b.trigger("Clear")})},l=function(b){var c=a(b),d={},f=!1;return c.find("input[name],select[name],textarea[name]").each(function(){var b=a(this),c=b.attr("name"),g=b.val();return/^$/.test(g)&&(g=b.attr("value"),/^$/.test(g)&&(g=b[0].getAttribute("value"))),b.hasClass("foswikiMandatory")&&(/^$/.test(g)||null===g||g===e)?(alert("TBD. missing value for mandatory field"),f=!0,!1):void(d[c]=g)}),f?null:d},m=function(b,c){if(null===c)return void b.each(function(){a(this).addClass("faded")});var d=a(c);b.each(function(){var b=a(this);b.addClass(b[0]===d[0]?"selected":"faded")})},n=function(a){var c={id:a.id},d=i(a);return b.each(d,function(b){var d=a[b.raw];if("dt"===b.type){var e=moment(d);d=e.format("DD MMM YYYY")}c[b.name]=d}),typeof c.Description==typeof e&&(c.Description="n/a"),c},o=function(a,c,d){var e=[],f=Object.getOwnPropertyNames(c);b.each(f,function(a){var f=b.findWhere(d,{name:a});"object"==typeof f&&(f.value=c[a],e.push(f))}),b.each(e,function(b){a[b.raw]=b.value})},p=function(a){a&&d.console&&console.error&&console.error(a)};a(c).ready(function(){a(".tasktracker").tasksGrid()})}(jQuery,window._,window.document,window);