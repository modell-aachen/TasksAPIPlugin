!function(a,b,c,d,e){"use strict";a.fn.tasksGrid=function(){return typeof b==typeof e?(p("Missing dependency underscore.js"),this):(a("#task-editor").length||a("body").append('<div id="task-editor"></div>'),this.each(function(){var e=a(this),f=e.attr("id"),k=e.children(".settings").text(),l=a.parseJSON(k);l.cntHeight=e.height(),l.container=e.children(".tasks-table").children(".tasks"),l.currentState="open",e.data("tasktracker_options",l);var m=l.container,o=a("#task-editor"),q=e.children(".filter"),r=q.find('select[name="status"]'),s=A();if(s.state&&(l.currentState=s.state,r.val(s.state)),j(e,l.currentState,!0),l.infinite){var t=!1,u=function(){if(!t){var b=a(d).scrollTop(),j=a(c).height(),k=a(d).height(),m=.8;if(b/(j-k)>m){var o=e.find("> .tasks-table > tbody > tr").length;if(o>=l.totalsize)return t=!1,!1;var q=g()+"?page="+Math.round(o/l.pagesize+.5);s.state&&(q+="&state="+s.state),a('<div class="tasks-tmp-container" style="display: none"></div>').appendTo("body"),a.blockUI(),t=!0,a(".tasks-tmp-container").load(q+" #"+f,function(){var b=a(this),c=b.find("#"+f+"> .tasks-table > tbody > tr");if(c.length<l.pagesize&&a(d).off("scroll",u),c.each(function(){var b=a(this).detach(),c=b.find("> .task-data-container > .task-data");if(c.length>0){var d=i(a.parseJSON(c.text()));d.html=a("<div></div>").append(b).html(),l.container.append(n(d))}}),t=!1,b.remove(),l.sortable)try{h.call(e.children(".tasks-table"),!1,!0)}catch(g){p(g)}a.unblockUI()})}}};a(d).on("scroll",u)}var y=function(){var c={};a.extend(c,l),c.trackerId=l.id,c._depth=parseInt(l.depth),delete c.id,delete c.depth;var d,f=a(this);if(f.hasClass("task-new")){c.$table=f.parent();var g=f.closest(".task-children-container").prev();if(d=g.data("id")){c.parent=d;var h=g.data("task_data");c._depth=parseInt(h.depth)-1}}else c.$table=a(l.container);var i=a.Event("beforeCreate");if(e.trigger(i,c),i.isDefaultPrevented())return!1;delete c.$table,delete c.container,delete c.lang;var j=i.result;return b.isObject(j)&&(delete j.id,delete j.trackerId,a.extend(c,j)),o.taskEditor(c).done(function(b,c){if("save"===b){{c.fields.Parent.value}d?a(n(c)).insertBefore(f):l.container.append(n(c)),v()}}).fail(p),!1},z=function(){var b=a(this),c=g()+"?state="+b.val();d.location=c};if(q.find(".tasks-btn-create").on("click",y),e.on("click",".task-new",y),r.on("change",z),o.on("afterSave",function(b,c){if(r.length>0&&c.Status!==r.val()&&m.find(".task").each(function(){var b=a(this);return b.data("id")===c.id?(b.remove(),!1):void 0}),l.sortable)try{h.call(e.children(".tasks-table"),!0)}catch(d){p(d)}}),l.sortable)try{h.call(e.children(".tasks-table"))}catch(B){p(B)}else e.observe("added","tr.task",function(){x(),w()});return this}))};var f,g=function(){var a=foswiki.preferences;return[a.SCRIPTURL,"/view",a.SCRIPTSUFFIX,"/",a.WEB,"/",a.TOPIC].join("")},h=function(b,c){var d=a(this);if(b||0!==d.find("> tbody .task").length){c&&setTimeout(function(){d.trigger("update")},10);var e=d.data("sortopts");if("object"!=typeof e)e=d.metadata()||{},d.data("sortopts",e),d.tablesorter(e).bind("sortStart",y).bind("sortEnd",z);else{var f=d.find("> thead .headerSortUp, > thead .headerSortDown").first();if(d.trigger("update"),f.length>0){var g=f.hasClass("headerSortUp")?1:0,h=f[0].column;setTimeout(function(){d.trigger("sorton",[[[h,g]]])},10)}}}},i=function(a){if(!a.fields)return a;for(var b in a.fields)a.fields[b].value=a.fields[b].value.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&");return a},j=function(c,d,e,f,g){var h=a.Deferred(),j=c.data("tasktracker_options");if(g||(g=j.container),j.query){var k=a.parseJSON(j.query);k.Status&&j.currentState&&(k.Status=j.currentState,j.query=JSON.stringify(k))}if(e){var l=[];return a(g).children(".task").each(function(b,c){var d=a(c),e=i(a.parseJSON(d.children(".task-data-container").children(".task-data").text()));m(d,e),l.push(e),d.find(".task-children .tasks").each(function(){a(this).children(".task").each(function(){var b=a(this),c=i(a.parseJSON(b.children(".task-data-container").children(".task-data").text()));m(b,c)})})}),h.resolve({data:l}),h.promise()}a.blockUI();var o={Context:j.context};"any"!==j.parent&&(o.Parent=f||""),a.extend(o,a.parseJSON(j.query)),o.Status=/^(1|true)$/i.test(j.stateless)||"all"===d?"all"!==j.currentState?[j.currentState]:["open","closed"]:d;var p={};return a.extend(p,j),p.query=o,p._depth=j.depth,a.taskapi.get(p).always(function(){a.unblockUI()}).done(function(a){b.each(a.data,function(a){var b=n(a);g.append(b)}),h.resolve(a.data)}).fail(h.reject),h.promise()},k=function(b){var c,d;/^(left|up|prev)$/i.test(b)?(c="last",d="prev"):(c="first",d="next");var e=a(this),f=e[d]();if(f.hasClass("task-children-container")&&(f=f[d]()),!f.hasClass("task")){{e.parent().children(c)}f=e.parent().children(".task")[c]()}return f},l=function(){if(!f)return!1;var c=f,e={isDetailsView:c.hasClass("highlight"),container:c},g=a.Event("toggleDetails"),h=c.closest(".tasktracker");h.trigger(g,e);var i=function(){var e=this;c.children(".task-fullview-container").children(".task-fullview").detach().appendTo(this),c.addClass("highlight");var g=a(d).height(),i=d.scrollY,j=c.offset().top,l=c.height();(j+l>i+g||i>j)&&a("body,html").animate({scrollTop:j-l});var m=function(){var d=a(this),f=d.closest(".task-fullview").children(".comment"),g=f.find("textarea").val(),i=f.find('input[name="close"]'),j=h.data("tasktracker_options")||{},k={id:c.data("id"),comment:g};a.extend(k,b.pick(j,"form","tasktemplate","templatefile"));var l=i.attr("checked");return l&&(k.Status="closed"),a.blockUI(),a.taskapi.update(k).fail(p).done(function(b){var d=c.is(".expanded"),f=a(n(b.data));if(c.replaceWith(f),d){f.next().remove();var g=f.children(".expander");s.call(g)}h.panel.replace.call(e,f),l&&a(".tasks-btn-next:visible").trigger("click")}).always(a.unblockUI),!1},q=function(){var b=a(this),c=b.closest(".task-fullview").children(".upload");return c.toggleClass("active"),!1},r=function(b){var c=a(this),d=c.closest(".task-fullview").children(".comment"),e=c.closest(".task-fullview").children(".upload");e.is(".active")&&e.removeClass("active"),d.toggleClass("active");var f=c.closest(".actions"),g=f.children(".active"),h=f.children(".hidden");return g.toggleClass("active").toggleClass("hidden"),h.toggleClass("active").toggleClass("hidden"),b.data===!0&&d.find('input[name="close"]').prop("checked",!0),!1},t=function(){return a("#task-panel").children(".close").click(),f=c,o(),!1},u=function(){var b=a(this),c=b.data("web"),e=b.data("topic"),f=c+"."+e;a.taskapi.get({query:{id:f}}).done(function(c){if("ok"===c.status&&0!==c.data.length){var e=a(c.data[0].html),f=e.children(".task-fullview-container").find(".viewer").detach();if(f.find(".tasks-btn-edit").on("click",t),b.closest(".task-fullview").children(".viewer").replaceWith(f),d.foswiki.ModacContextMenuPlugin){var g=f.find("div.foswikiAttachments > table"),h=g.find("td.foswikiTableCol1");a.each(h,function(a,b){foswiki.ModacContextMenuPlugin.attachContextMenu(b)})}}})},v=function(){return f=k.call(c,"next"),h.panel.replace.call(e,f),!1},w=function(){return f=k.call(c,"prev"),h.panel.replace.call(e,f),!1},x=function(){var b=a(this),c=b.closest(".actions"),d=c.children(".active"),e=c.children(".hidden");d.toggleClass("active").toggleClass("hidden"),e.toggleClass("active").toggleClass("hidden");var f=c.parent().children(".comment");return f.find("textarea").val(""),f.find('input[name="close"]').prop("checked",!1),f.toggleClass("active"),!1};this.find(".tasks-btn-next").on("click",v),this.find(".tasks-btn-prev").on("click",w),this.find(".tasks-btn-comment").on("click",r),this.find(".tasks-btn-upload").on("click",q),this.find(".qw-dnd-upload").on("queueEmpty",u),this.find(".tasks-btn-edit").on("click",t),this.find(".tasks-btn-close").on("click",!0,r),this.find(".tasks-btn-save-comment").on("click",m),this.find(".tasks-btn-cancel-comment").on("click",x)},j=function(){this.find(".tasks-btn-save-comment").off("click"),this.find(".tasks-btn-cancel-comment").off("click"),this.find(".tasks-btn-comment").off("click"),this.find(".tasks-btn-upload").off("click"),this.find(".tasks-btn-edit").off("click"),this.find(".tasks-btn-next").off("click"),this.find(".tasks-btn-close").off("click"),this.find(".tasks-btn-prev").off("click"),this.find(".qw-dnd-upload").off("queueEmpty"),this.find(".task-fullview").detach().appendTo(c.children(".task-fullview-container")),c.removeClass("highlight")};h.panel=h.taskPanel({show:i,hide:j,replace:function(b){var d=this;j.call(d),c=f=a(b),i.call(d)}}),h.panel.show()},m=function(a,b){a.data("id",b.id),a.data("task_data",b)},n=function(b){var c=a(b.html);return m(c,b),c},o=function(){if(!f)return!1;var b=f,c={},d=b.closest(".tasktracker"),e=d.data("tasktracker_options");for(var g in e)/string|number|boolean/.test(typeof e[g])&&(c[g]=e[g]);var h=i(a.parseJSON(b.children(".task-data-container").text()));c.autoassign=e.autoassign,c.data=h,c.id=h.id,c.lang=e.lang,c._depth=h.depth,c.trackerId=d.attr("id");var j=b.is(".expanded");b.addClass("highlight"),a("#task-editor").taskEditor(c).done(function(c,d){if(b.removeClass("highlight"),"save"===c){if("deleted"===d.fields.Status.value)b.remove();else{var e=a(n(d));if(b.replaceWith(e),j){e.next().remove();var f=e.children(".expander");s.call(f)}}v()}}).fail(function(a,b){p(b)})},p=function(){d.console&&console.error&&b.each([].splice.call(arguments,0),function(a){console.error(a)})},q=function(){var b=a(this);f=b},r=function(){var b=a(this).parent();b.detach().appendTo(a(f).children(".task-controls")),f=e},s=function(){var b=a(this),c=b.parent();c.toggleClass("expanded");var d=b.closest(".tasks-table:not(.children)");d.trigger("update");var e=c.hasClass("expanded");if(e){var f=c.children("td").length,g=c.children(".task-children").children("table.children").detach(),h=a('<tr class="task-children-container"><td class="dashed-line" colspan="'+f+'"></td></tr>');h.children("td").append(g),h.insertAfter(c)}else{var i=c.next(),j=i.children("td").children("table.children").detach();j.appendTo(c.children(".task-children")),i.remove()}v()},t=function(){var a=f;return u()?!1:(a.removeClass("highlight"),!1)},u=function(){f.addClass("highlight");{var b=f,c=b.next(),d=f.closest(".tasktracker");d.data("tasktracker_options")}swal({title:"Sind Sie sicher?",text:"Möchten Sie diesen Protokollpunkt schließen?",type:"warning",showCancelButton:!0,confirmButtonColor:"#6CCE86",cancelButtonColor:"#BDBDBD",confirmButtonText:"Ja",cancelButtonText:"Nein",closeOnConfirm:!1},function(d){if(d){var e=f.data("task_data"),g={id:e.id,Status:"closed"};a.blockUI(),a.taskapi.update(g).fail(p).done(function(){b.remove(),c.hasClass("task-children-container")&&c.remove(),swal("Erledigt!","Protokollpunkt wurde als geschlossen markiert.","success")}).always(a.unblockUI)}return d})},v=function(){a(".task:visible, .task-new:visible").each(function(b,c){for(var d=0,e=a(c),f=a(this);f.parent().closest(".tasks-table").length;)f=f.parent().closest(".tasks-table"),d++;e.attr("class",function(a,b){return b.replace(/(^|\s)alternate/g,"")+(d%2===0?" alternate":"")})})},w=function(){x(),a(".tasks .task").on("mouseenter",q).on("click",".expander",s).on("click",l),a(".table-task-actions .btn-close").on("click",t),a(".table-task-actions .btn-details").on("click",l),a(".table-task-actions .btn-edit").on("click",o)},x=function(){a(".tasks .task").off("mouseenter",q).off("click",".expander",s).off("click",l),a(".table-task-actions .btn-close").off("click",t),a(".table-task-actions .btn-details").off("click",l),a(".table-task-actions .btn-edit").off("click",o),a(".table-task-actions .task-btn").off("click",r)},y=function(){a(".tasktracker").disconnect()},z=function(){a(".tasktracker").observe("added","tr.task",function(){w()})},A=function(a){var b=a||d.location.search||"";/^;|#|\?/.test(b)&&(b=b.substr(1));for(var c={},e=b.split("&"),f=0;f<e.length;++f){var g=e[f].split("=");c[g[0]]=g[1]}return c};a(c).ready(function(){a(".tasktracker").tasksGrid(),w(),v()})}(jQuery,window._,window.document,window),function(a,b,c,d,e){"use strict";a.fn.taskEditor=function(c){if(0!==this.length){var d=this;d.data("id",b.isUndefined(c.id)?"":c.id),d.data("parent",b.isUndefined(c.parent)?"":c.parent),c.trackerId&&d.data("trackerId",c.trackerId);var g=a.Deferred(),j=a.Event("beforeEdit");if(d.trigger(j,c),j.isDefaultPrevented())return g.resolve("cancel_plugin",c),g.promise();var k=c.data;delete c.data,k||(k={fields:{}});var m=j.result;b.isObject(m)&&(c=b.extend(c,m)),a.blockUI(),i(c).done(function(e){l(e.scripts),l(e.styles);var f=a("<div>"+e.editor+"</div>");if(f.find(".ma-taskeditor-cke").addClass("ignoreObserver"),d.html(f.html()),d.find(".tasks-btn-save").click(p),d.find(".tasks-btn-cancel").click(o),q(k),c.autoassign&&c.autoassignTarget){var g=d.find('select[name="Type"]'),h=d.find('input[name="'+c.autoassignTarget+'"]'),i=(c.autoassign.split(","),{}),j=[];b.each(c.autoassign.split(","),function(a){var b=a.split("=");i[b[0]]=b[1],j.push(b[1])});var m=function(){var b=a(this),d=b.val(),e=i[d];if(e)h.closest("."+c.autoassignTarget).css("display","none"),setTimeout(function(){h.trigger("Clear"),h.trigger("AddValue",e)},100);else{h.closest("."+c.autoassignTarget).css("display","block");var f=h.val();-1===j.indexOf(d)&&-1===j.indexOf(f)&&h.trigger("Clear")}};g.on("change",m),m.call(g)}d.panel=d.taskPanel({show:function(){var b=this;d.find(".ignoreObserver").removeClass("ignoreObserver"),d.detach().appendTo(b),a("#InputTitle input").focus()},hide:function(){o(),d.detach().empty().appendTo(a("body"))}}),d.panel.show();var n=a.Event("afterEdit");d.trigger(n)}).fail(function(a){g.reject("lease",a)}).always(a.unblockUI);var n=function(){b.isUndefined(this)||d.panel.hide()},o=function(){var b=this,e=d.find(".qw-dnd-upload");e.length&&e.clearQueue();var f=c.id;return f?(a.blockUI(),h({id:f}).always(a.unblockUI).fail(function(a){g.reject("cancel_clearlease",a)}).done(function(){g.resolve("cancel",f)}).always(function(){n.call(b)}),!1):(g.resolve("cancel"),n.call(b),!1)},p=function(){var b=r();if(b.hasError){var e=decodeURIComponent(c.lang.missingField)+": "+b.missingFields;return alert(e),!1}for(var h in c)/template|form/.test(h)&&(b[h]=c[h]);d.data("parent")&&!b.Parent&&(b.Parent=d.data("parent"));var i=a.Event("beforeSave");if(d.trigger(i,b),i.isDefaultPrevented())return!1;a.blockUI();var j=function(){return b._depth=c._depth>0?c._depth:0,b.id?void a.taskapi.update(b).fail(f).done(function(c){var e=a.Event("afterSave");d.trigger(e,b),n.call(1),g.resolve("save",c.data)}).always(a.unblockUI):(b.Context=c.context,b.Status||(b.Status="open"),void a.taskapi.create(b).fail(f).always(a.unblockUI).done(function(c){b.id=c.id;var e=a.Event("afterSave");d.trigger(e,b),n.call(1),g.resolve("save",c.data)}))},k=d.find(".qw-dnd-upload");return k.length?(k.on("queueEmpty",j),k.upload()):j(),!1},q=function(a){b.each(a.fields,function(a){var b=["input#",a.name,",",'input[name="',a.name,'"],textarea[name="',a.name,'"],select[name="',a.name,'"]'].join(""),c=d.find(b);if(c.hasClass("foswikiEditFormDateField")){if(/^\d+$/.test(a.value)||/^\d+\s\w+\s\d+$/.test(a.value)){var e;/^\d+\s\w+\s\d+$/.test(a.value)?e=new Date(a.value):(e=new Date,e.setTime(parseInt(a.value+"000"))),c.val(e.print("%e %b %Y"))}}else c.val(a.value)})},r=function(){var b={id:d.data("id"),hasError:!1},c=[];return d.find("input[name],select[name],textarea[name]").each(function(){var d=a(this),g=d.attr("name"),h=d.val();if(d.hasClass("foswikiEditFormDateField"))try{if(h){var i=new Date(h);h=i.print("%s")}}catch(j){f(j)}if(/^$/.test(h)&&(h=d.attr("value"),/^$/.test(h)&&(h=d[0].getAttribute("value"))),d.hasClass("foswikiMandatory")&&(/^$/.test(h)||null===h||h===e)){var k=d.parent().find("span").text().replace(/\*/g,"");return c.push(k),b.hasError=!0,!1}b[g]=null!==h?h:""}),b.hasError&&(b.missingFields=c.join(", ")),b};return g.promise()}};var f=function(a){a&&d.console&&console.error&&console.error(a)},g=function(b,c){var d=a.Deferred(),e=foswiki.preferences,f=[e.SCRIPTURL,"/rest",e.SCRIPTSUFFIX,"/TasksAPIPlugin/",b].join("");return a.ajax({url:f,data:c,success:function(b){var c=a.parseJSON(b);d.resolve(c)},error:function(a,b,c){d.reject(c)}}),d.promise()},h=function(a){var b={request:JSON.stringify(a)};return g("release",b)},i=function(a){var b={request:JSON.stringify(a)};return g("lease",b,a.id)},j=[],k=function(b,c){-1===j.indexOf(b)&&(j.push(b),a(c).appendTo(a("head")))},l=function(c){var d=a("head"),e=d.html();b.each(c,function(a){var c=new RegExp(a.id);c.test(e)||(b.each(a.requires,function(a){var b=new RegExp(a.id);b.test(e)||k(a.id,a.text)}),k(a.id,a.text),e=d.html())})}}(jQuery,window._,window.document,window),function(a){"use strict";a.fn.taskPanel=function(d){0===a("#task-panel").length&&(a('<div id="task-panel"><div class="close"></div><div class="content"></div></div>').appendTo("body"),a('<div id="task-overlay"></div>').appendTo("body")),a("#task-overlay").off("click").on("click",function(){c(d)}),a("#task-panel > .close").off("click").on("click",function(){c(d)});var e=a("#task-panel"),f=(e.children(".content"),function(){var a=this;setTimeout(function(){c(a),b()},100)}),g=function(){if(CKEDITOR&&CKEDITOR.instances)for(var a in CKEDITOR.instances)CKEDITOR.instances[a].destroy()};return{hide:function(){f.call(d),g()},replace:function(){"function"==typeof d.replace&&(d.replace.apply(this,arguments),b())},show:function(){f.call(d)}}};var b=function(){var b=a("#task-panel").children(".content");b.find("a:not(.tasks-btn)").each(function(){var b=a(this);"#"!==b.attr("href")&&b.attr("target","_blank")})},c=function(b){var c=a("#task-overlay"),d=a("#task-panel").children(".content"),e=a("body");c.toggleClass("active"),c.hasClass("active")?(e.css("overflow","hidden"),c.show(),"function"==typeof b.show&&b.show.call(d),a("#task_desc_box article").readmore({collapsedHeight:150,speed:200,lessLink:'<a class="readmore_link" href="#">Weniger anzeigen</a>',moreLink:'<a class="readmore_link" href="#">Mehr anzeigen</a>'}),a("#task-panel .task-changeset").slice(3).hide(),a("#task-panel .task-changeset").length>3&&(a('<a id="more-changeset" href="">Weitere Änderungen anzeigen</a>').insertAfter("#task-panel .task-changeset:last"),a("#more-changeset").on("click",function(){return a("#task-panel .task-changeset").fadeIn("slow"),a("#more-changeset").off("click"),a("#more-changeset").remove(),!1}))):(a("#task-panel .task-changeset").show(),a("#more-changeset").off("click"),a("#more-changeset").remove(),a("#task_desc_box article").readmore("destroy"),c.hide(),e.css("overflow",""),"function"==typeof b.hide&&b.hide.call(d)),a("#task-panel").toggleClass("active")}}(jQuery,window._,window.document,window);